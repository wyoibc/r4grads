---
title: "Tidyverse and data visualization"
author: "Sean Harrington"
date: "2023-03-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/r4grads/Fish_data/Modified/")
```


## Set up:

If you don't have the data from last time handy, or have forgotten where you put it, use the instructions from the last session to re-download it. Then set your working directory to where the data are:

```{r, eval = FALSE}
setwd("~/r4grads/Fish_data/Modified/")
```

We'll need our `all_data` object again. If you have your `"fish_data_merged.csv"` file that we wrote out last time, you can read in:

```{r}
all_data <- read.csv("fish_data_merged.csv")
```

If you've lost track of this file, we can create it again:

```{r}
body <- read.csv("Fish_body_size.csv")
iso <- read.csv("Fish_isotopes.csv")
all_data <- merge(body, iso)
```

<br>
<br>

# Tidyverse

<br>

So far, we've done all of the manipulation using base R functions. We can also do a lot of fancy data manipulation using the [Tidyverse](https://www.tidyverse.org/) set of R packages, which all share some general principles in their architecture. I won't go into the details of the Tidyverse philosphy, as it's very well documented and you can read all about it at the link.


<br>

To start, you'll need to make sure you have the Tidyverse packages installed and then loaded:

```{r eval = FALSE}
install.packages("tidyverse")
```
```{r}
library(tidyverse)
```

<br>

Before we actually start doing anything, there's an important issue to point out in this loading message. The conflicts show that there are functions in `dplyr` and the base R `stats` packages that share the same function names. Whenever this happens, the function from the most recently loaded package will mask the other function. If you load `dplyr` last and then run `filter()`, what you'll get is the function from `dplyr`. Alternately, if you load `stats` last, you'll get the `filter()` function from that package.

This is important to keep track of. Especially if you write a script and then edit it to load up a package at the the top of a script. You can always call a function from a specific package by using the notation `package::function()`. The double colons tell R to explicitly use a function from the stated package before the colons.

<br>


Some of these functions are very similar to base R functions. E.g., `str_replace()` is very similar to `gsub()`, but with a different order of arguments: 

```{r}
body <- read.csv("Fish_body_size.csv")
body$Species <- str_replace(body$Species, "Steelhesd", "Steelhead")
```


<br>

We can filter data using the `filter()` function, this is similar to how we filtered data using base R:

```{r}
coho_data <- filter(all_data, Species == "Coho")
big_coho <- filter(all_data, Species == "Coho" & Fork.length..cm. > 10)
```

We can select only certain columns using `select()`:

```{r}
big_coho_size_vars <- select(big_coho, Weight..g., Fork.length..cm.)
```

We can add in columns that are combinations or transformations of others:

```{r}
  big_coho2 <- mutate(
    big_coho,
    mass2 = Weight..g. * 2,
    mass2_squared = mass2 ^ 2
  )
```

<br>

We can also get useful summaries of our data grouped however we want. E.g., we can get the mean weight of each species from our `all_data` object:

```{r}
by_spec <- group_by(all_data, Species)
summarise(by_spec, size = mean(Weight..g., na.rm = TRUE))
```


<br>

Tidyverse has all sorts of functions like these that each do specific data manipulations that you can explore at your leisure. Many people love Tidyverse and use it for all of their data manipulation, others prefer to use base R for basic manipulations and use Tidyverse only for more complex operations. It's totally up to you which you prefer and which makes more sense to you.

<br>

## Tibbles

On top of all sorts of functions, Tidyverse also introduces a couple other important pieces of functionality: tibbles and pipes.

Tibbles are effectively an extension of the dataframe format that has very specific rules. You can read all about them [here](https://tibble.tidyverse.org/).

You can convert dataframes to tibbles like so:


```{r}
big_coho_tib <- as_tibble(big_coho)
big_coho_tib
```

Notice that this prints differently from a dataframe. There are some other key differences, including that Tibbles do not have row names (instead this information is expected to be as a column within the tibble). Use whichever you prefer. In many cases, they operate pretty much interchangeably, although some functions from various packages will require input data to be in one of the formats or the other -- it is easy to convert back and forth, though.


<br>

You can also read data into R straight into a tibble using Tidyverse functions:

```{r}
body_tib <- read_csv("Fish_body_size.csv")
body_tib
```




Note that is almost the same as the base `read.csv()` function, just with an underscore instead of a period. You can also read in tab delimited data using `read_tsv()` and there are probably Tidyverse equivalents of most functions to read in data.

<br>
<br>

## Pipes

<br>

Pipes allow you to chain (or "pipe") together multiple functions into a single long command. If you're familiar with the Linux/Unix command line, this is done with the `|` character. R uses that for some other purposes, so Tidyverse instead introduces the pipe as `%>%`.


When you pipe a function to another function, the output from the first function becomes the data argument of the second function, and you can link many pipes together.

<br>

For example, we can pipe together all of the commands we used above to make the big_coho2 object:


```{r}
big_coho3 <- filter(all_data, Species == "Coho" & Fork.length..cm. > 10) %>%
  select(Weight..g., Fork.length..cm.) %>%
  mutate(
    mass2 = Weight..g. * 2,
    mass2_squared = mass2 ^ 2
  )
```


<br>

Try out piping together `group_by()` and `summarise()` to get an object that has the mean and standard deviation of the weight of each species from the `all_data` object:

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

```{r}
weight_sum <- group_by(all_data, Species) %>%
  summarise(size = mean(Weight..g., na.rm = TRUE), stdev = sd(Weight..g., na.rm = TRUE))

weight_sum
```


<br>

We could also add in some other columns using mutate:

```{r}
weight_sum2 <- group_by(all_data, Species) %>%
  summarise(
    size = mean(Weight..g., na.rm = TRUE), 
    stdev = sd(Weight..g., na.rm = TRUE)
    ) %>%
  mutate(
    lower = size - stdev,
    upper = size + stdev
    )

weight_sum2
```

<br>

Here, I've split up single functions onto multiple lines to improve readability: each column being created by `summarise()` and `mutate()` gets its own line.



<br>

There are advantages and disadvantages to piping together commands. A major advantage is that you don't need to store intermediate data objects that you aren't going to use as objects in R's memory. A disadvantage is that if you pipe together too many commands, your code can start to become less readable.

<br>
<br>

As already mentioned, we've really only scarped the surface of how to manipulate data with either base R or Tidyverse. There is a whole book [R for Data Science](https://r4ds.had.co.nz/index.html) written by the primary developers (or at least originators) of Tidyverse. That link will take you to the site for the free book, which is filled with code examples.

<br>
<br>
<br>
<br>
<br>






